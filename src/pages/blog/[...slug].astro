---
import { type CollectionEntry, getCollection } from 'astro:content';
import BlogPost from '../../layouts/BlogPost.astro';
import { render } from 'astro:content';

export const prerender = false;

// Check authentication
// Note: Since we are prerendering, we cannot check cookies here.
// Authentication for static pages needs to be handled client-side or via middleware for non-static routes.
// However, the user wants to keep markdown posts as is.
// If we want to protect them, we cannot use `prerender = true`.
// But `getStaticPaths` is only for `prerender = true`.
// The warning says: "getStaticPaths() ignored in dynamic page".
// So we should remove getStaticPaths if we want it to be dynamic (SSR) OR make it static.
// Given the plan says "Keep current server-side Markdown rendering for pages under /blog/* as-is",
// and the user wants a private site, we should probably keep it dynamic (SSR) to check auth.
// So we should REMOVE getStaticPaths and fetch the post dynamically based on the slug.

// const token = Astro.cookies.get('accessToken')?.value;
// if (!token) {
//   return Astro.redirect('/login');
// }

// export async function getStaticPaths() {
// 	const posts = await getCollection('blog');
// 	return posts.map((post) => ({
// 		params: { slug: post.id },
// 		props: post,
// 	}));
// }
// type Props = CollectionEntry<'blog'>;

// const post = Astro.props;
// const { Content } = await render(post);

// REVISED IMPLEMENTATION FOR SSR:
const { slug } = Astro.params;
const posts = await getCollection('blog');
const post = posts.find((page) => page.id === slug);

if (!post) {
  return Astro.redirect('/404');
}

// Check authentication
const token = Astro.cookies.get('accessToken')?.value;
if (!token) {
  return Astro.redirect('/login');
}

const { Content } = await render(post);
---

<BlogPost {...post.data}>
	<Content />
</BlogPost>
