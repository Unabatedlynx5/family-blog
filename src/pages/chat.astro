---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
---
<html>
  <head>
    <BaseHead title="Chat" />
  </head>
  <body>
    <Header />
    <main class="container">
      <div class="chat-window">
        <div id="messages" class="chat-messages"></div>
        <div class="chat-input">
          <textarea id="msg" rows="2" placeholder="Say hello to family..."></textarea>
          <button id="send" class="button">Send</button>
        </div>
      </div>
    </main>
    <Footer />

    <script type="module">
      const ws = new WebSocket(`${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}/api/chat/connect`);
      const messages = document.getElementById('messages');
      ws.addEventListener('message', (e)=>{
        const data = JSON.parse(e.data);
        if(data.type === 'message'){
          const d = data.message;
          const el = document.createElement('div');
          el.textContent = `${d.user_id}: ${d.text}`;
          messages.appendChild(el);
          messages.scrollTop = messages.scrollHeight;
        }
      });
      document.getElementById('send').addEventListener('click', ()=>{
        const text = document.getElementById('msg').value;
        if(!text) return;
        ws.send(JSON.stringify({ user_id: 'LOCAL-ADMIN', text }));
        document.getElementById('msg').value = '';
      });
    </script>
  </body>
</html>
