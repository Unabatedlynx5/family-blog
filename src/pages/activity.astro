---
import SocialLayout from '../layouts/SocialLayout.astro';
import UploadButton from '../components/activity/UploadButton.astro';
import ActivityCard from '../components/activity/ActivityCard.astro';
import FullscreenSlideshow from '../components/activity/FullscreenSlideshow.astro';

export const prerender = false;

const user = Astro.locals.user;
if (!user) {
  return Astro.redirect('/login');
}

// SSR Data Fetch
const env = Astro.locals.runtime.env as any;
let events = [];

try {
  // Fetch events
  const limit = 20;
  const eventsMsg = await env.DB.prepare(`
    SELECT e.id, e.created_at, e.user_id, u.name as user_name, u.avatar_url as user_avatar
    FROM upload_events e
    JOIN users u ON e.user_id = u.id
    ORDER BY e.created_at DESC
    LIMIT ?
  `).bind(limit).all();

  events = eventsMsg.results;
  
  if (events.length > 0) {
    const eventIds = events.map((e:any) => `'${e.id}'`).join(',');
    // Note: D1 doesn't support array binding for IN clause well, using string interpolation for IDs is risky if not sanitized, 
    // but UUIDs are safe-ish. Better: multiple ? marks.
    // For simplicity MVP we trust UUIDs generated by us.
    
    const photosMsg = await env.DB.prepare(`
      SELECT id, event_id, width, height
      FROM photos 
      WHERE event_id IN (${eventIds})
    `).all();

    const photosByEvent: Record<string, any[]> = {};
    photosMsg.results.forEach((p: any) => {
      if (!photosByEvent[p.event_id]) photosByEvent[p.event_id] = [];
      if (photosByEvent[p.event_id].length < 4) {
           photosByEvent[p.event_id].push({
               id: p.id,
               url: `/api/media/${p.id}`,
               width: p.width,
               height: p.height
           });
      }
    });

    events.forEach((e: any) => {
      e.photos = photosByEvent[e.id] || [];
    });
  }
} catch (e) {
  console.error("Failed to load activity feed", e);
}
---

<SocialLayout title="Activity">
  <div class="max-w-4xl mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-[#1c1e21] dark:text-[#e4e6eb]">Activity</h1>
        <div class="flex gap-2">
             <button onclick="window.startSlideshow()" class="bg-[#e4e6eb] dark:bg-[#3a3b3c] hover:bg-[#d8dadf] dark:hover:bg-[#4e4f50] text-[#050505] dark:text-[#e4e6eb] font-bold py-2 px-4 rounded-full shadow transition flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Slideshow
             </button>
             <UploadButton />
        </div>
    </div>

    <div class="space-y-6">
        {events.length === 0 ? (
            <div class="text-center py-10 text-[#65676b] dark:text-[#b0b3b8]">
                <p>No activity yet. Upload some photos!</p>
            </div>
        ) : (
            events.map((event: any) => (
                <ActivityCard event={event} />
            ))
        )}
    </div>
  </div>

  <FullscreenSlideshow />
</SocialLayout>
