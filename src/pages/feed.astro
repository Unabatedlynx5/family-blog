---
import SocialLayout from '../layouts/SocialLayout.astro';

export const prerender = false;

// Check authentication
const user = Astro.locals.user;
if (!user) {
  return Astro.redirect('/login');
}
---
<SocialLayout title="Feed">


  <div id="composer" class="bg-white dark:bg-[#242526] p-4 rounded-lg shadow-sm mb-4">
    <textarea id="content" rows="3" placeholder="What's on your mind?" class="w-full border-none bg-[#f0f2f5] dark:bg-[#3a3b3c] dark:text-[#e4e6eb] p-4 rounded-3xl resize-none font-inherit box-border mb-4 focus:outline-none"></textarea>
    <div class="flex justify-between items-center border-t border-[#e4e6eb] dark:border-[#3e4042] pt-4">
      <div class="relative overflow-hidden inline-block group">
        <div class="flex items-center gap-2 px-3 py-2 rounded-lg group-hover:bg-[#f0f2f5] dark:group-hover:bg-[#3a3b3c] group-hover:text-[#667eea] cursor-pointer text-[#65676b] dark:text-[#b0b3b8] font-semibold transition-colors">
            <span>üñºÔ∏è</span> Photo
        </div>
        <input id="file" type="file" accept="image/*" class="absolute left-0 top-0 opacity-0 w-full h-full cursor-pointer text-[100px]" />
      </div>
      <button id="post" class="px-8 py-2 bg-[#667eea] text-white border-none rounded-lg font-bold cursor-pointer hover:bg-[#5a6fd6]">Post</button>
    </div>
  </div>

  <div id="posts" class="flex flex-col gap-4"></div>

  <script type="module" is:inline>
    import { marked } from "https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";

    async function loadFeed(){
      const res = await fetch('/api/feed');
      const json = await res.json();
      const posts = json.posts || [];
      const container = document.getElementById('posts');
      container.innerHTML = '';
      for(const p of posts){
        const el = document.createElement('div');
        el.className = 'bg-white dark:bg-[#242526] rounded-lg shadow-sm p-4';
        
        let contentHtml = p.content;
        // Always treat content as markdown
        try {
            contentHtml = marked.parse(p.content);
        } catch (e) {
            console.error('Markdown parse error', e);
        }

        let mediaHtml = '';
        if (p.media_url) {
            mediaHtml = `<img src="${p.media_url}" class="block max-w-full h-auto mx-auto my-4 rounded-lg max-h-[600px] object-contain" alt="Post image" loading="lazy" />`;
        }
        
        const dateStr = p.created_at ? new Date(p.created_at*1000).toLocaleString(undefined, {
            year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
        }) : '';

        const avatarUrl = p.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(p.name || 'User')}&background=random`;

        el.innerHTML = `
          <div class="flex items-center mb-3">
            <img src="${avatarUrl}" class="w-10 h-10 rounded-full mr-3 object-cover border border-gray-200 dark:border-gray-700" alt="${p.name}" />
            <div>
              <div class="font-bold text-[#1c1e21] dark:text-[#e4e6eb]">${p.name || p.user_id || (p.source==='markdown'? 'System' : 'Anonymous')}</div>
              <div class="text-xs text-[#65676b] dark:text-[#b0b3b8]">${dateStr}</div>
            </div>
          </div>
          <div class="text-[#1c1e21] dark:text-[#e4e6eb] leading-relaxed prose dark:prose-invert max-w-none">${contentHtml}</div>
          ${mediaHtml}
          <div class="border-t border-[#e4e6eb] dark:border-[#3e4042] mt-4 pt-2 flex justify-around">
            <div class="px-4 py-2 rounded cursor-pointer text-[#65676b] dark:text-[#b0b3b8] font-semibold flex items-center gap-2 hover:bg-[#f0f2f5] dark:hover:bg-[#3a3b3c]">
                <span>üëç</span> Like
            </div>
            <div class="px-4 py-2 rounded cursor-pointer text-[#65676b] dark:text-[#b0b3b8] font-semibold flex items-center gap-2 hover:bg-[#f0f2f5] dark:hover:bg-[#3a3b3c]">
                <span>üí¨</span> Comment
            </div>
          </div>
        `;
        container.appendChild(el);
      }
    }

    document.getElementById('post').addEventListener('click', async ()=>{
      const content = document.getElementById('content').value;
      const fileInput = document.getElementById('file');
      const file = fileInput.files[0];
      
      const token = sessionStorage.getItem('accessToken');
      
      let mediaId = null;
      
      if (file) {
        const formData = new FormData();
        formData.append('file', file);
        
        try {
          const uploadRes = await fetch('/api/media/upload', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`
            },
            body: formData
          });
          
          if (!uploadRes.ok) {
            alert('Upload failed');
            return;
          }
          
          const uploadJson = await uploadRes.json();
          mediaId = uploadJson.media.id;
          
          // If we just uploaded an image, let's append it to the content for now as a markdown image
          // or just rely on the backend to link it.
          // The current backend for posts doesn't explicitly link media yet in the POST /api/feed endpoint 
          // (it just takes content).
          // Let's append the image markdown to the content.
          // content += `\n\n![Image](/api/media/${mediaId})`; 
          // Actually, let's just post the text for now, and maybe we need to update the feed API to handle media_id.
        } catch (e) {
          console.error(e);
          alert('Error uploading file');
          return;
        }
      }

      if(!content && !mediaId) return;

      const payload = { content };
      if (mediaId) {
          payload.media_id = mediaId;
      }

      const res = await fetch('/api/feed', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(payload)
      });

      if(res.ok){
        document.getElementById('content').value = '';
        document.getElementById('file').value = '';
        loadFeed();
      } else {
        const errText = await res.text();
        console.error('Post failed:', res.status, errText);
        alert(`Failed to post: ${res.status} ${errText}`);
      }
    });

    loadFeed();
  </script>
</SocialLayout>
