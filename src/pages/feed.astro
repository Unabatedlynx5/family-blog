---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
---
<html>
  <head>
    <BaseHead title="Feed" />
  </head>
  <body>
    <Header />
    <main class="container">
      <section id="composer" class="composer">
        <textarea id="content" placeholder="Share an update with family..."></textarea>
        <div class="controls">
          <div>
            <input id="file" type="file" />
          </div>
          <div>
            <button id="post" class="button">Post</button>
            <button id="clear" class="button secondary">Clear</button>
          </div>
        </div>
      </section>

      <section id="posts" style="margin-top:1rem;"></section>
    </main>
    <Footer />

    <script type="module">
      async function loadFeed(){
        const res = await fetch('/api/feed');
        const json = await res.json();
        const posts = json.posts || [];
        const container = document.getElementById('posts');
        container.innerHTML = '';
        for(const p of posts){
          const el = document.createElement('div');
          el.className = 'post-card';
          el.innerHTML = `
            <div class="avatar"></div>
            <div class="body">
              <div class="meta">${p.name || p.user_id || (p.source==='markdown'? 'Markdown' : 'Anonymous')} â€¢ ${p.created_at ? new Date(p.created_at*1000).toLocaleString() : ''}</div>
              <div class="content">${p.source==='markdown' ? `<strong>${p.filename}</strong><div><pre style="white-space:pre-wrap;margin:0">${p.content.slice(0,400)}</pre></div>` : p.content}</div>
            </div>
          `;
          container.appendChild(el);
        }
      }
      document.getElementById('post').addEventListener('click', async ()=>{
        const content = document.getElementById('content').value;
        const token = sessionStorage.getItem('accessToken');
        const res = await fetch('/api/posts', { method:'POST', headers: { 'Content-Type':'application/json', 'Authorization': `Bearer ${token}`, 'x-user-id': 'LOCAL-ADMIN' }, body: JSON.stringify({ content }) });
        if(res.ok){
          document.getElementById('content').value='';
          loadFeed();
        }
      });
      document.getElementById('clear').addEventListener('click', ()=>{ document.getElementById('content').value=''; });
      loadFeed();
    </script>
  </body>
</html>
