---
import SocialLayout from '../layouts/SocialLayout.astro';
import RichTextEditor from '../components/RichTextEditor.astro';

export const prerender = false;

// Check authentication
const user = Astro.locals.user;
if (!user) {
  return Astro.redirect('/login');
}
---
<SocialLayout title="Feed">
  <style>
    @keyframes thumb-bounce {
      0% { transform: scale(1) rotate(0deg); }
      50% { transform: scale(1.2) rotate(-15deg) translateY(-2px); }
      100% { transform: scale(1) rotate(0deg); }
    }
    .animate-thumb {
      animation: thumb-bounce 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
  </style>

  <div id="composer" class="bg-white dark:bg-[#242526] p-4 rounded-lg shadow-sm mb-4">
    <div class="mb-4">
      <RichTextEditor id="content" placeholder="What's on your mind?" />
    </div>
    <div class="flex justify-between items-center border-t border-[#e4e6eb] dark:border-[#3e4042] pt-4">
      <div class="relative overflow-hidden inline-block group">
        <div class="flex items-center gap-2 px-3 py-2 rounded-lg group-hover:bg-[#f0f2f5] dark:group-hover:bg-[#3a3b3c] group-hover:text-[#667eea] cursor-pointer text-[#65676b] dark:text-[#b0b3b8] font-semibold transition-colors">
            <span>üñºÔ∏è</span> Photo
        </div>
        <input id="file" type="file" accept="image/*" class="absolute left-0 top-0 opacity-0 w-full h-full cursor-pointer text-[100px]" />
      </div>
      <button id="post" class="px-8 py-2 bg-[#667eea] text-white border-none rounded-lg font-bold cursor-pointer hover:bg-[#5a6fd6]">Post</button>
    </div>
  </div>

  <div id="posts" class="flex flex-col gap-4"></div>

  <script type="module" is:inline>
    import { marked } from "https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";

    async function loadFeed(){
      const res = await fetch('/api/feed');
      const json = await res.json();
      const posts = json.posts || [];
      const container = document.getElementById('posts');
      container.innerHTML = '';
      for(const p of posts){
        const el = document.createElement('div');
        el.className = 'bg-white dark:bg-[#242526] rounded-lg shadow-sm p-4';
        
        let contentHtml = p.content;
        // Always treat content as markdown
        try {
            contentHtml = marked.parse(p.content);
        } catch (e) {
            console.error('Markdown parse error', e);
        }

        let mediaHtml = '';
        if (p.media_url) {
            mediaHtml = `<img src="${p.media_url}" class="block max-w-full h-auto mx-auto my-4 rounded-lg max-h-[600px] object-contain" alt="Post image" loading="lazy" />`;
        }
        
        const dateStr = p.created_at ? new Date(p.created_at*1000).toLocaleString(undefined, {
            year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
        }) : '';

        const avatarUrl = p.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(p.name || 'User')}&background=random`;

        const isLiked = p.user_has_liked;
        const likeCount = p.like_count || 0;
        const likeColorClass = isLiked ? 'text-blue-600' : 'text-[#65676b] dark:text-[#b0b3b8]';
        const likeIconClass = isLiked ? 'fill-current' : 'stroke-current fill-none';

        el.innerHTML = `
          <div class="flex items-center mb-3">
            <img src="${avatarUrl}" class="w-10 h-10 rounded-full mr-3 object-cover border border-gray-200 dark:border-gray-700" alt="${p.name}" />
            <div>
              <div class="font-bold text-[#1c1e21] dark:text-[#e4e6eb]">${p.name || p.user_id || (p.source==='markdown'? 'System' : 'Anonymous')}</div>
              <div class="text-xs text-[#65676b] dark:text-[#b0b3b8]">${dateStr}</div>
            </div>
          </div>
          <div class="text-[#1c1e21] dark:text-[#e4e6eb] leading-relaxed prose dark:prose-invert max-w-none">${contentHtml}</div>
          ${mediaHtml}
          <div class="border-t border-[#e4e6eb] dark:border-[#3e4042] mt-4 pt-2 flex justify-around">
            <button class="like-btn px-4 py-2 rounded cursor-pointer font-semibold flex items-center gap-2 hover:bg-[#f0f2f5] dark:hover:bg-[#3a3b3c] border-none bg-transparent ${likeColorClass}" data-id="${p.id}" data-liked="${isLiked}">
                <div class="thumb-icon-wrapper">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 like-icon ${likeIconClass}" viewBox="0 0 24 24" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5" />
                  </svg>
                </div>
                <span class="like-text">${isLiked ? 'Liked' : 'Like'}</span> 
                <span class="like-count ml-1 bg-gray-200 dark:bg-gray-700 px-1.5 rounded-full text-xs ${likeCount > 0 ? '' : 'hidden'}">${likeCount}</span>
            </button>
            <button class="comment-btn px-4 py-2 rounded cursor-pointer text-[#65676b] dark:text-[#b0b3b8] font-semibold flex items-center gap-2 hover:bg-[#f0f2f5] dark:hover:bg-[#3a3b3c] border-none bg-transparent" data-id="${p.id}">
                <span>üí¨</span> Comment
            </button>
          </div>
          <div class="comments-container hidden mt-4 pt-4 border-t border-gray-100 dark:border-gray-800" id="comments-${p.id}">
             <div class="text-center text-gray-500 text-sm">Comments coming soon...</div>
          </div>
        `;
        container.appendChild(el);
      }

      // Attach event listeners
      document.querySelectorAll('.like-btn').forEach(btn => {
        btn.addEventListener('click', handleLike);
      });
      
      document.querySelectorAll('.comment-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const id = e.currentTarget.dataset.id;
            const container = document.getElementById(`comments-${id}`);
            container.classList.toggle('hidden');
        });
      });
    }

    async function handleLike(e) {
        const btn = e.currentTarget;
        const id = btn.dataset.id;
        const isLiked = btn.dataset.liked === 'true';
        const iconSvg = btn.querySelector('.like-icon');
        const wrapper = btn.querySelector('.thumb-icon-wrapper');
        const textSpan = btn.querySelector('.like-text');
        const countSpan = btn.querySelector('.like-count');
        
        // Optimistic update
        const newLiked = !isLiked;
        const currentCount = parseInt(countSpan.textContent) || 0;
        const newCount = currentCount + (newLiked ? 1 : -1);
        
        btn.dataset.liked = newLiked;
        
        if (newLiked) {
            btn.classList.remove('text-[#65676b]', 'dark:text-[#b0b3b8]');
            btn.classList.add('text-blue-600');
            iconSvg.classList.remove('stroke-current', 'fill-none');
            iconSvg.classList.add('fill-current');
            textSpan.textContent = 'Liked';
            
            // Trigger animation
            wrapper.classList.remove('animate-thumb');
            void wrapper.offsetWidth; // Trigger reflow
            wrapper.classList.add('animate-thumb');
        } else {
            btn.classList.add('text-[#65676b]', 'dark:text-[#b0b3b8]');
            btn.classList.remove('text-blue-600');
            iconSvg.classList.add('stroke-current', 'fill-none');
            iconSvg.classList.remove('fill-current');
            textSpan.textContent = 'Like';
            wrapper.classList.remove('animate-thumb');
        }
        
        countSpan.textContent = newCount;
        if (newCount > 0) {
            countSpan.classList.remove('hidden');
        } else {
            countSpan.classList.add('hidden');
        }

        try {
            const res = await fetch('/api/likes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ target_id: id, target_type: 'post' })
            });
            
            if (!res.ok) {
                throw new Error('Failed to like');
            }
        } catch (err) {
            console.error(err);
            alert('Failed to like');
            // Revert UI changes if needed
            btn.dataset.liked = isLiked;
            countSpan.textContent = currentCount;
            if (isLiked) {
                btn.classList.remove('text-[#65676b]', 'dark:text-[#b0b3b8]');
                btn.classList.add('text-blue-600');
                iconSvg.classList.remove('stroke-current', 'fill-none');
                iconSvg.classList.add('fill-current');
                textSpan.textContent = 'Liked';
            } else {
                btn.classList.add('text-[#65676b]', 'dark:text-[#b0b3b8]');
                btn.classList.remove('text-blue-600');
                iconSvg.classList.add('stroke-current', 'fill-none');
                iconSvg.classList.remove('fill-current');
                textSpan.textContent = 'Like';
            }
        }
    }

    document.getElementById('post').addEventListener('click', async ()=>{
      const contentInput = document.getElementById('content-input');
      const content = contentInput.value;
      const fileInput = document.getElementById('file');
      const file = fileInput.files[0];
      
      const token = sessionStorage.getItem('accessToken');
      
      let mediaId = null;
      
      if (file) {
        const formData = new FormData();
        formData.append('file', file);
        
        try {
          const uploadRes = await fetch('/api/media/upload', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`
            },
            body: formData
          });
          
          if (!uploadRes.ok) {
            alert('Upload failed');
            return;
          }
          
          const uploadJson = await uploadRes.json();
          mediaId = uploadJson.media.id;
          
          // If we just uploaded an image, let's append it to the content for now as a markdown image
          // or just rely on the backend to link it.
          // The current backend for posts doesn't explicitly link media yet in the POST /api/feed endpoint 
          // (it just takes content).
          // Let's append the image markdown to the content.
          // content += `\n\n![Image](/api/media/${mediaId})`; 
          // Actually, let's just post the text for now, and maybe we need to update the feed API to handle media_id.
        } catch (e) {
          console.error(e);
          alert('Error uploading file');
          return;
        }
      }

      if(!content && !mediaId) return;

      const payload = { content };
      if (mediaId) {
          payload.media_id = mediaId;
      }

      const res = await fetch('/api/feed', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(payload)
      });

      if(res.ok){
        contentInput.dispatchEvent(new Event('reset-editor'));
        document.getElementById('file').value = '';
        loadFeed();
      } else {
        const errText = await res.text();
        console.error('Post failed:', res.status, errText);
        alert(`Failed to post: ${res.status} ${errText}`);
      }
    });

    loadFeed();

    // WebSocket Connection for Live Likes
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${wsProtocol}//${window.location.host}/api/feed/live`;
    let ws;

    function connectWebSocket() {
      ws = new WebSocket(wsUrl);

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          
          if (data.type === 'LIKE_UPDATE') {
            updateLikeCount(data.postId, data.count);
          }
        } catch (e) {
          console.error('Error parsing WS message:', e);
        }
      };

      ws.onclose = () => {
        // Reconnect after a delay
        setTimeout(connectWebSocket, 3000);
      };
    }

    function updateLikeCount(postId, count) {
      const btn = document.querySelector(`.like-btn[data-id="${postId}"]`);
      if (btn) {
        const countSpan = btn.querySelector('.like-count');
        if (countSpan) {
          countSpan.textContent = count;
          countSpan.classList.remove('hidden');
          if (count === 0) {
             countSpan.classList.add('hidden');
          }
        }
      }
    }

    // Start connection
    connectWebSocket();
  </script>
</SocialLayout>
