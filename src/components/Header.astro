---
import HeaderLink from './HeaderLink.astro';

// Server-side auth check
const token = Astro.cookies.get('accessToken')?.value;
let avatarSrc = 'https://ui-avatars.com/api/?name=User&background=random';

if (token) {
  try {
    const parts = token.split('.');
    const payload = JSON.parse(atob(parts[1]));
    const userId = payload.sub;
    const env = Astro.locals.runtime?.env as any;
    
    if (env?.DB) {
        const user = await env.DB.prepare('SELECT avatar_url, name FROM users WHERE id = ?').bind(userId).first();
        if (user?.avatar_url) {
            avatarSrc = user.avatar_url;
        } else if (user?.name) {
            avatarSrc = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=random`;
        }
    }
  } catch (e) {
    // Ignore errors
  }
}
---

<header class="bg-white dark:bg-[#242526] px-4 py-2 shadow-sm sticky top-0 z-50 h-14 box-border border-b dark:border-[#393a3b] w-full">
	<nav class="flex items-center justify-between h-full max-w-[1200px] mx-auto w-full">
		<!-- Logo -->
		<a href="/" class="font-extrabold text-2xl text-[#667eea] no-underline whitespace-nowrap">FamilyBlog</a>
		
		<!-- Desktop Links -->
		<div class="hidden md:flex items-center gap-2 mx-4 flex-1 justify-center">
			<a href="/" class="flex items-center px-3 py-2 rounded-lg transition-colors hover:bg-[#e4e6eb] dark:hover:bg-[#3a3b3c] font-semibold text-[#1c1e21] dark:text-[#e4e6eb] no-underline gap-2">
				<span class="text-xl">ğŸ </span> <span>Home</span>
			</a>
			<a href="/chat" class="flex items-center px-3 py-2 rounded-lg transition-colors hover:bg-[#e4e6eb] dark:hover:bg-[#3a3b3c] font-semibold text-[#1c1e21] dark:text-[#e4e6eb] no-underline gap-2">
				<span class="text-xl">ğŸ’¬</span> <span>Chat</span>
			</a>
			<a href="/pochsalad" class="flex items-center px-3 py-2 rounded-lg transition-colors hover:bg-[#e4e6eb] dark:hover:bg-[#3a3b3c] font-semibold text-[#1c1e21] dark:text-[#e4e6eb] no-underline gap-2">
				<span class="text-xl">ğŸ“</span> <span>Pochsalad</span>
			</a>
			<!-- <a href="/about" class="flex items-center px-3 py-2 rounded-lg transition-colors hover:bg-[#e4e6eb] dark:hover:bg-[#3a3b3c] font-semibold text-[#1c1e21] dark:text-[#e4e6eb] no-underline gap-2">
				<span class="text-xl">ğŸ‘‹</span> <span>About</span>
			</a> -->
			<a href="/settings" class="flex items-center px-3 py-2 rounded-lg transition-colors hover:bg-[#e4e6eb] dark:hover:bg-[#3a3b3c] font-semibold text-[#1c1e21] dark:text-[#e4e6eb] no-underline gap-2">
				<span class="text-xl">âš™ï¸</span> <span>Settings</span>
			</a>
		</div>

		<!-- User Menu or Sign In -->
		<div class="flex items-center gap-4">
			{token ? (
				<div class="relative group" id="header-user-menu-container">
					<img 
						src={avatarSrc} 
						alt="Profile" 
						class="w-10 h-10 rounded-full cursor-pointer object-cover border border-gray-200 dark:border-[#393a3b]"
						id="header-user-menu-btn"
					/>
					<!-- Dropdown -->
					<div id="header-user-dropdown" class="hidden absolute right-0 top-12 w-48 bg-white dark:bg-[#242526] rounded-lg shadow-lg py-1 border border-gray-100 dark:border-[#393a3b] z-50">
						<a href="/settings" class="block px-4 py-2 text-sm text-gray-700 dark:text-[#e4e6eb] hover:bg-gray-50 dark:hover:bg-[#3a3b3c] no-underline">Settings</a>
						<button id="header-logout-btn" class="w-full text-left block px-4 py-2 text-sm text-red-600 hover:bg-gray-50 dark:hover:bg-[#3a3b3c] border-none bg-transparent cursor-pointer">Log Out</button>
					</div>
				</div>
			) : (
				<a href="/login" class="px-3 py-2 rounded-md bg-[#e4e6eb] dark:bg-[#3a3b3c] hover:bg-[#d8dadf] dark:hover:bg-[#4e4f50] text-[#050505] dark:text-[#e4e6eb] font-semibold text-sm no-underline transition-colors whitespace-nowrap">Sign in</a>
			)}
		
            <!-- Mobile Menu Button -->
            <button id="mobile-menu-btn" class="md:hidden text-2xl bg-transparent border-none cursor-pointer text-[#65676b] dark:text-[#b0b3b8] p-1 flex items-center">
                â˜°
            </button>
		</div>
	</nav>

    <!-- Mobile Menu -->
    <div id="mobile-menu" class="hidden md:hidden absolute top-14 left-0 w-full bg-white dark:bg-[#242526] border-b dark:border-[#393a3b] p-4 flex-col gap-3 shadow-lg z-40">
        <HeaderLink href="/" class="block py-2">Home</HeaderLink>
        <HeaderLink href="/feed" class="block py-2">Feed</HeaderLink>
        <HeaderLink href="/chat" class="block py-2">Chat</HeaderLink>
        <HeaderLink href="/blog" class="block py-2">Blog</HeaderLink>
        <HeaderLink href="/about" class="block py-2">About</HeaderLink>
        <HeaderLink href="/settings" class="block py-2">Settings</HeaderLink>
    </div>
</header>

<script>
    const btn = document.getElementById('header-user-menu-btn');
    const dropdown = document.getElementById('header-user-dropdown');
    const logoutBtn = document.getElementById('header-logout-btn');
    const mobileBtn = document.getElementById('mobile-menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');

    btn?.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdown?.classList.toggle('hidden');
    });

    document.addEventListener('click', (e) => {
        if (!dropdown?.classList.contains('hidden') && !btn?.contains(e.target as Node)) {
            dropdown?.classList.add('hidden');
        }
    });

    logoutBtn?.addEventListener('click', async () => {
        try {
            await fetch('/api/auth/logout', { method: 'POST' });
            // clear session storage too just in case
            sessionStorage.removeItem('accessToken');
            sessionStorage.removeItem('userId');
            sessionStorage.removeItem('userName');
            window.location.href = '/login';
        } catch (e) {
            console.error('Logout failed', e);
        }
    });

    mobileBtn?.addEventListener('click', () => {
        if (mobileMenu) {
            mobileMenu.classList.toggle('hidden');
            mobileMenu.classList.toggle('flex');
        }
    });
</script>
